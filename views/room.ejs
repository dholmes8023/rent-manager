<%- include('partials/top', { title: `Phòng ${room.name}` }) %>
<a href="/" class="text-sm text-blue-600">&larr; Về danh sách</a>
<h1 class="text-xl font-semibold mt-2 mb-4">Phòng <%= room.name %></h1>

<div class="grid md:grid-cols-2 gap-6">
  <div class="bg-white border rounded-xl p-4">
    <div class="flex items-center justify-between">
      <h2 class="font-medium mb-3">Thông tin chung</h2>
      <a href="/rooms/<%= room.id %>/edit" class="text-sm px-3 py-1 rounded-lg border">Sửa phòng</a>
    </div>
    <ul class="text-sm leading-7">
      <li>Trạng thái:
        <% if (tenant) { %>
          <span class="px-2 py-0.5 text-xs rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Đã có người</span>
        <% } else { %>
          <span class="px-2 py-0.5 text-xs rounded-full bg-amber-50 text-amber-700 border border-amber-200">Phòng trống</span>
        <% } %>
      </li>
      <li>Người thuê: <b><%= tenant?.full_name || "—" %></b> <%= tenant?.phone ? '('+tenant.phone+')' : '' %></li>
      <li>Tiền phòng: <b><span class="num"><%= tariff.rent %></span></b> / tháng</li>
      <li>Mạng: <b><span class="num"><%= tariff.internet_fee %></span></b> / tháng</li>
      <li>Vệ sinh: <b><span class="num"><%= tariff.cleaning_fee %></span></b> / tháng</li>
      <li>Đơn giá điện: <b><span class="num"><%= tariff.electricity_price %></span></b> đ/kWh</li>
      <li>Đơn giá nước: <b><span class="num"><%= tariff.water_price %></span></b> đ/m³</li>
    </ul>

    <div class="mt-4 border-t pt-3">
      <h3 class="font-medium mb-2">Quản lý người thuê</h3>
      <form method="POST" action="/rooms/<%= room.id %>/tenant" class="grid grid-cols-2 gap-3">
        <label class="text-sm col-span-2">Họ tên
          <input name="full_name" class="input" value="<%= tenant?.full_name || '' %>" required />
        </label>
        <label class="text-sm">SĐT
          <input name="phone" class="input" value="<%= tenant?.phone || '' %>" />
        </label>
        <label class="text-sm">Ngày bắt đầu
          <input type="date" name="started_at" class="input" value="<%= tenant?.started_at || new Date().toISOString().slice(0,10) %>" />
        </label>
        <div class="col-span-2">
          <button class="px-4 py-2 rounded-lg bg-slate-900 text-white">Lưu người thuê</button>
          <% if (tenant) { %>
            <button formaction="/rooms/<%= room.id %>/tenant/end" formmethod="POST" class="ml-2 px-4 py-2 rounded-lg border">Kết thúc thuê</button>
          <% } %>
        </div>
      </form>
    </div>
  </div>

  <div class="bg-white border rounded-xl p-4">
    <h2 class="font-medium mb-3">Nhập chỉ số tháng</h2>

    <div class="mb-3">
      <label class="text-sm">Chọn tháng
        <input type="month" id="month_ui" class="input" required />
      </label>
      <div class="text-xs text-slate-500 mt-1">Chọn tháng để xem/sửa chỉ số hoặc in hoá đơn nếu đủ dữ liệu.</div>
    </div>

    <form method="POST" action="/rooms/<%= room.id %>/meter" onsubmit="syncMonth()">
      <input type="hidden" name="yyyymm" id="yyyymm" value="<%= yyyymm %>" />
      <div class="grid grid-cols-2 gap-3">
        <label class="text-sm">Điện đầu
          <input type="number" step="0.1" name="elec_start" value="<%= meter?.elec_start ?? prefill?.elec_start ?? '' %>" class="input" required />
        </label>
        <label class="text-sm">Điện cuối
          <input type="number" step="0.1" name="elec_end" value="<%= meter?.elec_end ?? '' %>" class="input" required />
        </label>

        <label class="text-sm">Nước đầu
          <input type="number" step="0.1" name="water_start" value="<%= meter?.water_start ?? prefill?.water_start ?? '' %>" class="input" required />
        </label>
        <label class="text-sm">Nước cuối
          <input type="number" step="0.1" name="water_end" value="<%= meter?.water_end ?? '' %>" class="input" required />
        </label>
      </div>
      <button class="mt-3 px-4 py-2 rounded-lg bg-slate-900 text-white">Lưu chỉ số</button>
      <% if (hasCompleteMeter) { %>
        <a class="ml-2 px-4 py-2 rounded-lg border" href="/rooms/<%= room.id %>/invoice/<%= yyyymm %>">Xem/Tạo hoá đơn</a>
      <% } %>
      <% if (prevYyyymm) { %>
        <div class="text-xs text-slate-500 mt-2">Chỉ số đầu mặc định lấy từ tháng trước (<%= prevYyyymm %>).</div>
      <% } %>
    </form>
    <script>
    (function(){
      var yyyymm = "<%= yyyymm %>";
      var y = yyyymm.slice(0,4), m = yyyymm.slice(4,6);
      var el = document.getElementById('month_ui');
      if (el) {
        el.value = y + '-' + m;
        el.addEventListener('change', function(){
          var v = this.value; // YYYY-MM
          if (v) {
            var parts = v.split('-');
            var target = parts[0] + parts[1];
            window.location = '/rooms/<%= room.id %>?yyyymm=' + target;
          }
        });
      }
    })();
    function syncMonth(){
      var ym = document.getElementById('yyyymm');
      if (!ym) return;
      // keep current yyyymm
    }
    </script>
  </div>
</div>

<div class="mt-8 bg-white border rounded-xl p-4">
  <h2 class="font-medium mb-3">Lịch sử hoá đơn</h2>
  <ul class="list-disc pl-6">
    <% invoices.forEach(inv => { %>
      <li>
        <a class="text-blue-600" href="/rooms/<%= room.id %>/invoice/<%= inv.yyyymm %>"><%= inv.yyyymm %></a>
        — tổng: <b><span class="num"><%= inv.total %></span></b>
      </li>
    <% }) %>
  </ul>
</div>

<script>
document.querySelectorAll('.num').forEach(function(n){
  var v = Number(n.textContent||0);
  n.textContent = new Intl.NumberFormat('vi-VN').format(v) + ' đ';
});
</script>
<%- include('partials/bottom') %>